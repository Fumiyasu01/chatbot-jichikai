# RAG ã‚·ã‚¹ãƒ†ãƒ å…¨é¢æ”¹å–„ææ¡ˆæ›¸

**ä½œæˆæ—¥**: 2025å¹´10æœˆ4æ—¥
**ç¾åœ¨ã®å•é¡Œ**: ã€Œç‡ƒãˆã‚‹ã‚´ãƒŸã€ã®æ›œæ—¥ã‚’é–“é•ãˆã‚‹ã€ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„ãªã©ã€åŸºæœ¬çš„ãªæƒ…å ±æ¤œç´¢ãŒå¤±æ•—

---

## ğŸ”´ ç¾åœ¨ã®å®Ÿè£…ã®è‡´å‘½çš„ãªå•é¡Œ

### 1. **ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°æˆ¦ç•¥ã®æ¬ é™¥**
- âŒ æ”¹è¡Œã‚’å…¨ã¦åœ§ç¸®ã—ã¦ã„ãŸï¼ˆä¿®æ­£æ¸ˆã¿ã ãŒã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œã§æœªåæ˜ ï¼‰
- âŒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ï¼ˆè¦‹å‡ºã—ï¼‰ãŒãƒãƒ£ãƒ³ã‚¯ã«å«ã¾ã‚Œã¦ã„ãªã„
- âŒ å›ºå®šã‚µã‚¤ã‚ºåˆ†å‰²ã®ã¿ï¼ˆã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯åˆ†å‰²ãªã—ï¼‰

### 2. **æ¤œç´¢æˆ¦ç•¥ã®å•é¡Œ**
- âŒ **ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ã¿** - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãªã—
- âŒ **Rerankingãªã—** - é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã ã‘ã§æ±ºå®š
- âŒ **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ãªã—** - dense + sparse retrieverã®çµ„ã¿åˆã‚ã›ãªã—

### 3. **ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®æ¬ å¦‚**
- âŒ æ¤œç´¢çµæœã®è©³ç´°ãƒ­ã‚°ãŒãªã„
- âŒ é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ãŒè¦‹ãˆãªã„
- âŒ ã©ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ã‚ã‚ŒãŸã‹ä¸æ˜

### 4. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã®ä¸è¶³**
- âš ï¸  ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯æ”¹å–„ã—ãŸãŒã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æç¤ºæ–¹æ³•ãŒä¸ååˆ†
- âš ï¸  å¼•ç”¨å…ƒã®æ˜è¨˜ãŒä¸å®Œå…¨

---

## âœ… RAGãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ 2025

### **æ¨å¥¨ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º**
- **200-400ãƒˆãƒ¼ã‚¯ãƒ³** (ç¾åœ¨: 400æ–‡å­— â‰ˆ 100ãƒˆãƒ¼ã‚¯ãƒ³ = å°ã•ã™ãã‚‹å¯èƒ½æ€§)
- ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—: 0-15% (ç¾åœ¨: 100/400 = 25% = å¤šã™ãã‚‹)

### **ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°æˆ¦ç•¥**
1. **Semantic Chunking with Contextual Headers** ğŸ†
   - ãƒãƒ£ãƒ³ã‚¯ã”ã¨ã«è¦ªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¦‹å‡ºã—ã‚’ä»˜ä¸
   - ä¾‹: ã€Œ## 2. ã‚´ãƒŸå‡ºã—ãƒ«ãƒ¼ãƒ« > ### 2.1 åé›†æ—¥ > ç‡ƒãˆã‚‹ã‚´ãƒŸ: æ¯é€±æœˆæ›œæ—¥ãƒ»æœ¨æ›œæ—¥ã€

2. **Document-Specific Splitters**
   - MarkdownTextSplitterï¼ˆMarkdownæ§‹é€ ã‚’ä¿æŒï¼‰

3. **Cluster-Based Semantic Chunking**
   - æ„å‘³çš„ã«è¿‘ã„æ–‡ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–

### **æ¤œç´¢æˆ¦ç•¥**
1. **Hybrid Search** ğŸ†
   - Dense retriever (ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢)
   - Sparse retriever (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢: BM25ãªã©)
   - ä¸¡æ–¹ã®çµæœã‚’Rank Fusionã§çµ±åˆ

2. **Reranking**
   - Cohere Rerank API
   - ã¾ãŸã¯ self-hosted reranker (cross-encoder)

3. **Query Expansion**
   - HyDEãªã©ï¼ˆã‚¯ã‚¨ãƒªã‚’æ‹¡å¼µã—ã¦æ¤œç´¢ç²¾åº¦å‘ä¸Šï¼‰

---

## ğŸ—ï¸ æ”¹å–„æ¡ˆ3ã¤ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³

### **ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: ç¾åœ¨ã®æ§‹æˆã‚’æ”¹å–„ï¼ˆæœ€å°é™ã®å¤‰æ›´ï¼‰**

**å¤‰æ›´å†…å®¹**:
1. âœ… ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°æ”¹å–„ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
   - æ”¹è¡Œä¿æŒ
   - Markdownè¦‹å‡ºã—ã§åˆ†å‰²
   - Contextual headerã®è¿½åŠ 

2. ğŸ†• æ¤œç´¢çµæœã®ãƒ­ã‚°è¿½åŠ 
   - é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢è¡¨ç¤º
   - æ¤œç´¢ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®å†…å®¹è¡¨ç¤º

3. ğŸ†• ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„
   - å¼•ç”¨ã®å¼·åŒ–
   - Few-shot examplesè¿½åŠ 

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ğŸ’° ã‚³ã‚¹ãƒˆå¢—åŠ ãªã—
- âš¡ æ—¢å­˜ã‚¤ãƒ³ãƒ•ãƒ©ã®ã¾ã¾
- ğŸ”§ å®Ÿè£…ãŒç°¡å˜

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ğŸ” æ¤œç´¢ç²¾åº¦ã«é™ç•Œ
- âš ï¸  ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ã¿ã§ã¯ã€Œæœˆæ›œæ—¥ã€ãªã©ã®å›ºæœ‰åè©ã«å¼±ã„

**æ¨å®šç²¾åº¦**: 60-70%

---

### **ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: LlamaIndexå°å…¥ï¼ˆä¸­ç¨‹åº¦ã®å¤‰æ›´ï¼‰**

**å¤‰æ›´å†…å®¹**:
1. **LlamaIndexãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å°å…¥**
   ```bash
   npm install llamaindex
   ```

2. **MarkdownReader + RecursiveCharacterTextSplitter**
   ```typescript
   import { MarkdownReader, VectorStoreIndex } from 'llamaindex'

   const reader = new MarkdownReader()
   const documents = await reader.loadData('jichikai_rules.md')

   const index = await VectorStoreIndex.fromDocuments(documents, {
     chunkSize: 512,
     chunkOverlap: 50
   })
   ```

3. **Hybrid Search (BM25 + Vector)**
   ```typescript
   const retriever = index.asRetriever({
     similarityTopK: 10,
     mode: 'hybrid' // BM25 + Vector
   })
   ```

4. **Contextual Chat Engine**
   ```typescript
   const chatEngine = index.asChatEngine({
     chatMode: 'context',
     systemPrompt: '...'
   })
   ```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ğŸš€ 40%é«˜é€Ÿãªæ¤œç´¢
- ğŸ“Š 35%é«˜ã„æ¤œç´¢ç²¾åº¦
- ğŸ”§ ç°¡å˜ãªå®Ÿè£…ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒæä¾›ï¼‰
- ğŸ” ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢å¯¾å¿œ

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ğŸ“¦ ä¾å­˜é–¢ä¿‚å¢—åŠ 
- ğŸ”„ æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ›ãˆå¿…è¦
- ğŸ’° ã‚ãšã‹ã«ã‚³ã‚¹ãƒˆå¢—ï¼ˆBM25ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰

**æ¨å®šç²¾åº¦**: 80-85%

**ã‚³ã‚¹ãƒˆ**: æœˆé¡ +$5-10ï¼ˆSupabase storageï¼‰

---

### **ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰RAGã‚µãƒ¼ãƒ“ã‚¹ï¼ˆå¤§è¦æ¨¡å¤‰æ›´ï¼‰**

**å€™è£œã‚µãƒ¼ãƒ“ã‚¹**:
1. **Pinecone + LlamaIndex**
2. **Weaviate (self-hosted or cloud)**

#### **3-A: Pinecone + LlamaIndex**

**å¤‰æ›´å†…å®¹**:
```typescript
import { Pinecone } from '@pinecone-database/pinecone'
import { VectorStoreIndex } from 'llamaindex'

const pc = new Pinecone({ apiKey: process.env.PINECONE_API_KEY })
const index = pc.Index('jichikai-chatbot')

const vectorStore = new PineconeVectorStore({ index })
const ragIndex = await VectorStoreIndex.fromDocuments(documents, {
  vectorStore,
  serviceContext: {
    chunkSize: 512,
    chunkOverlap: 50
  }
})
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âš¡ è¶…é«˜é€Ÿæ¤œç´¢ï¼ˆå°‚ç”¨ã‚¤ãƒ³ãƒ•ãƒ©ï¼‰
- ğŸ“ˆ ç„¡é™ã‚¹ã‚±ãƒ¼ãƒ«
- ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸è¦
- ğŸ“Š Built-in analytics

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ğŸ’° é«˜ã‚³ã‚¹ãƒˆï¼ˆæœˆé¡$70ï½ï¼‰
- ğŸ”„ å¤§è¦æ¨¡æ›¸ãæ›ãˆ
- ğŸŒ å¤–éƒ¨ä¾å­˜

**æ¨å®šç²¾åº¦**: 90-95%

**ã‚³ã‚¹ãƒˆ**: æœˆé¡ $70-200

---

#### **3-B: Weaviate (self-hosted)**

**å¤‰æ›´å†…å®¹**:
```docker
# docker-compose.yml
services:
  weaviate:
    image: semitechnologies/weaviate:latest
    ports:
      - "8080:8080"
    environment:
      ENABLE_MODULES: 'text2vec-openai'
```

```typescript
import weaviate from 'weaviate-ts-client'

const client = weaviate.client({
  scheme: 'http',
  host: 'localhost:8080',
})

// Hybrid search with keyword + vector
const result = await client.graphql
  .get()
  .withClassName('Document')
  .withHybrid({
    query: message,
    alpha: 0.5 // balance between keyword and vector
  })
  .withLimit(5)
  .do()
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ğŸ” æœ€å¼·ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢
- ğŸ–¼ï¸  ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œï¼ˆå°†æ¥ã®ç”»åƒå¯¾å¿œï¼‰
- ğŸ’° ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã§ä½ã‚³ã‚¹ãƒˆ
- ğŸ› ï¸  GraphQL APIï¼ˆæŸ”è»Ÿãªã‚¯ã‚¨ãƒªï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ğŸ³ Dockerã‚¤ãƒ³ãƒ•ãƒ©å¿…è¦
- ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è¤‡é›‘
- ğŸ”„ å¤§è¦æ¨¡æ›¸ãæ›ãˆ

**æ¨å®šç²¾åº¦**: 90-95%

**ã‚³ã‚¹ãƒˆ**: æœˆé¡ $10-30ï¼ˆã‚µãƒ¼ãƒãƒ¼ä»£ï¼‰

---

## ğŸ“Š æ¯”è¼ƒè¡¨

| é …ç›® | ã‚ªãƒ—ã‚·ãƒ§ãƒ³1<br>(ç¾çŠ¶æ”¹å–„) | ã‚ªãƒ—ã‚·ãƒ§ãƒ³2<br>(LlamaIndex) | ã‚ªãƒ—ã‚·ãƒ§ãƒ³3-A<br>(Pinecone) | ã‚ªãƒ—ã‚·ãƒ§ãƒ³3-B<br>(Weaviate) |
|------|------------------------|--------------------------|--------------------------|--------------------------|
| **å®Ÿè£…é›£æ˜“åº¦** | â­ ç°¡å˜ | â­â­ ä¸­ç¨‹åº¦ | â­â­â­ é›£ã—ã„ | â­â­â­â­ æœ€é›£ |
| **é–‹ç™ºæ™‚é–“** | 1-2æ—¥ | 3-5æ—¥ | 5-7æ—¥ | 7-10æ—¥ |
| **æœˆé¡ã‚³ã‚¹ãƒˆ** | $0 | $5-10 | $70-200 | $10-30 |
| **æ¤œç´¢ç²¾åº¦** | 60-70% | 80-85% | 90-95% | 90-95% |
| **ã‚¹ã‚±ãƒ¼ãƒ«æ€§** | ä½ | ä¸­ | æœ€é«˜ | é«˜ |
| **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹** | é«˜ | ä¸­ | æœ€ä½ | ä¸­ |

---

## ğŸ¯ æ¨å¥¨: **ã‚ªãƒ—ã‚·ãƒ§ãƒ³2 (LlamaIndexå°å…¥)**

### ç†ç”±
1. âœ… **è²»ç”¨å¯¾åŠ¹æœãŒæœ€é«˜**
   - æœˆé¡$5-10ã§80-85%ã®ç²¾åº¦
   - Pineconeã®1/10ã®ã‚³ã‚¹ãƒˆ

2. âœ… **å®Ÿè£…ãŒç¾å®Ÿçš„**
   - 3-5æ—¥ã§å®Œæˆ
   - æ—¢å­˜ã®Supabase + OpenAIæ§‹æˆã‚’ç¶­æŒ

3. âœ… **ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æº–æ‹ **
   - Hybrid search
   - Semantic chunking
   - Contextual headers

4. âœ… **å°†æ¥ã®æ‹¡å¼µæ€§**
   - å¾Œã§Pineconeã‚„Weaviateã«ç§»è¡Œå¯èƒ½
   - LlamaIndexã¯ã©ã®ãƒ™ã‚¯ãƒˆãƒ«DBã¨ã‚‚é€£æº

---

## ğŸš€ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³2ï¼‰

### **Phase 1: LlamaIndexå°å…¥ï¼ˆ1æ—¥ï¼‰**
1. `llamaindex`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. MarkdownReaderã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
3. Supabase VectorStoreé€£æº

### **Phase 2: ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°æ”¹å–„ï¼ˆ1æ—¥ï¼‰**
1. RecursiveCharacterTextSplitterå®Ÿè£…
2. Contextual headerè¿½åŠ 
3. ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºæœ€é©åŒ–ï¼ˆ512ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰

### **Phase 3: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆ1-2æ—¥ï¼‰**
1. BM25ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ï¼ˆSupabase pg_searchæ‹¡å¼µï¼‰
2. Hybrid retrieverå®Ÿè£…
3. Rank fusion

### **Phase 4: ãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ï¼ˆ1æ—¥ï¼‰**
1. ã‚µãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒªã§ãƒ†ã‚¹ãƒˆ
2. ç²¾åº¦è©•ä¾¡
3. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

**åˆè¨ˆ: 4-5æ—¥**

---

## ğŸ“ å³åº§ã«å®Ÿæ–½ã™ã¹ãç·Šæ€¥å¯¾å¿œ

### **ä»Šã™ãã§ãã‚‹ã“ã¨ï¼ˆ30åˆ†ï¼‰**

1. **è©³ç´°ãƒ­ã‚°è¿½åŠ **
   ```typescript
   // chat/route.tsã«è¿½åŠ 
   console.log('=== SEARCH RESULTS ===')
   console.log('Query:', message)
   console.log('Matched docs:', matchedDocs?.length || 0)
   matchedDocs?.forEach((doc: any, i: number) => {
     console.log(`[${i+1}] ${doc.file_name} (similarity: ${doc.similarity})`)
     console.log(`Content: ${doc.content.substring(0, 200)}...`)
   })
   ```

2. **ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ï¼‹å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**
   - âœ… å®Ÿæ–½æ¸ˆã¿: `.next`å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
   - ğŸ”„ å¿…è¦: ç®¡ç†ç”»é¢ã‹ã‚‰`jichikai_rules.md`ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

3. **å‹•ä½œç¢ºèª**
   - ã€Œç‡ƒãˆã‚‹ã‚´ãƒŸã®æ›œæ—¥ã¯?ã€
   - ã€Œã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚‹?ã€
   - ãƒ­ã‚°ã§æ¤œç´¢çµæœã‚’ç¢ºèª

---

## ğŸ’¡ çµè«–

**ä»Šã™ã**: ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•æ¸ˆã¿ã€‚ç®¡ç†ç”»é¢ã‹ã‚‰`jichikai_rules.md`ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ†ã‚¹ãƒˆã€‚

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: å‹•ä½œç¢ºèªå¾Œã€**ã‚ªãƒ—ã‚·ãƒ§ãƒ³2 (LlamaIndex)** ã®å®Ÿè£…ã‚’æ¨å¥¨ã€‚4-5æ—¥ã§ç¾åœ¨ã®å•é¡Œã‚’æ ¹æœ¬è§£æ±ºã—ã€80-85%ã®æ¤œç´¢ç²¾åº¦ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

äºˆç®—ã«ä½™è£•ãŒã‚ã‚Œã°ã€**ã‚ªãƒ—ã‚·ãƒ§ãƒ³3-B (Weaviate)** ã§æœ€é«˜ç²¾åº¦ã‚’ç›®æŒ‡ã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
